<!DOCTYPE html> 
  
<html lang="en"> 

<head> 
   <meta charset="utf-8"> 
   <title>Custom HTML5 Video Player</title> 
   <link rel="stylesheet" type="text/css" href="style.css">
</head> 

<body>

<p>Start playback.</p>

<button onclick="myFunction()">Click to play</button>

<p id="demo"></p>

</body>

<script>

var mainTimerHandle = "";
var ticksPerSecond = 10;    //Define timer resolution

function myFunction() {
    document.getElementById("demo").innerHTML = "Started";
    mainTimerHandle = setInterval(mainTimer, 1000/ticksPerSecond);
}

var mainIterationCount = 0;
var scriptAdded = new Boolean(false);

var sampleDecodeTimes  = [0, 1];    //Decode times, less than the expected presentation times: check how loading the movie from remote server/buffering may impact this
var currentSample = 0;
var accumulatedTime = 1;

function mainTimer() {
    
    if (mainIterationCount == sampleDecodeTimes[currentSample]*ticksPerSecond)  //Assuming timer is accurate (defined by ticksPerSecond)
    {
        if(sampleDecodeTimes[currentSample] == 0)   //"init"/IDR information
            setTimeout(loadMainBody, 0);
        else
        {
            console.log("*********Iteration: " + mainIterationCount + ", loading: " + "InteractiveTrack/sample" + (currentSample) + ".tr");
            setTimeout(function(){loadScript_withTime("InteractiveTrack/sample" + (currentSample) + ".tr");}, 0);    
            //Load a sample            
        }        
    }
    
    mainIterationCount=mainIterationCount+1;
}

function loadMainBody()
{
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {      
        var nodeContents = this.responseText;
        document.getElementsByTagName('body')[0].innerHTML = nodeContents;
        loadScript("InteractiveTrack/main.tr");
    }
  };
  xhttp.open("GET", "InteractiveTrack/body.xml", true);
  xhttp.send();
}

function loadScript(scriptName)
{
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      
        var scriptContents = this.responseText;
        var theScript = document.createElement('script');
        theScript.appendChild(document.createTextNode(scriptContents));
        document.getElementsByTagName('head')[0].appendChild(theScript);
        scriptAdded = true;
        
    }
  };
  xhttp.open("GET", scriptName, true);
  xhttp.send();
  
  if(currentSample < sampleDecodeTimes.length)
    currentSample = currentSample + 1;  //Iterate over samples  
  
}

function loadScript_withTime(scriptName)
{
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      
        var scriptContentsWithTime = this.responseText;
        var scriptContents;

        	var components = scriptContentsWithTime.split('\n');
        time = components.shift();
        accumulatedTime = accumulatedTime + Number(time);
        sampleDecodeTimes.push(accumulatedTime);
        console.log("Updated sample decode time = " sampleDecodeTimes);
        
        
	scriptContents = components.join('\n');      
	
	//console.log(scriptContents);
	//console.log(time);
        
        var theScript = document.createElement('script');
        theScript.appendChild(document.createTextNode(scriptContents));
        document.getElementsByTagName('head')[0].appendChild(theScript);
        scriptAdded = true;       
    }
  };
  xhttp.open("GET", scriptName, true);
  xhttp.send();
  
  if(currentSample < sampleDecodeTimes.length)
    currentSample = currentSample + 1;  //Iterate over samples  
}

function loadXMLDoc() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("demo").innerHTML =
      this.responseText;
    }
  };
  xhttp.open("GET", "xmlhttp_info.txt", true);
  xhttp.send();
}


</script>


</html>
