<!DOCTYPE html> 
  
<html lang="en"> 

<head> 
   <meta charset="utf-8"> 
   <title>Custom HTML5 Video Player</title> 
   <link rel="stylesheet" type="text/css" href="style.css">
</head> 

<body>

<p>Start playback.</p>

<button onclick="myFunction()">Click to play</button>

<p id="demo"></p>

</body>

<script>

var mainTimerHandle = "";
var ticksPerSecond = 10;    //Define timer resolution
var vid;

function myFunction() {
    document.getElementById("demo").innerHTML = "Started";
    setTimeout(loadMainBody, 0); // Lo
    setTimeout(initializeVideo, 250);
    //mainTimerHandle = setInterval(mainTimer, 1000/ticksPerSecond);    
}

var mainIterationCount = 0;
var scriptAdded = new Boolean(false);

var sampleDecodeTimes  = [1];    //Decode times, less than the expected presentation times: check how loading the movie from remote server/buffering may impact this. The other decode times are read during the run-time.
var currentSample = 0;
var accumulatedTime = 1;
var video_previous_playback_time = -1;

function initializeVideo() {
  vid = document.getElementById("video");
  console.log(vid);
  vid.ontimeupdate = function () { 
	  mainTimer((Math.round(vid.currentTime)));
	  emulateReceiveAndStoreFunction(); 
	  emulateReceiveAndStoreLeftThumbnail(); 
	  addRemoveRightThumbnail();
    };
}

function mainTimer(currentPlaybackTime) {
  //console.log("Current playback time =" + currentPlaybackTime);
  //console.log("Video previous playback time =" + video_previous_playback_time);
  //console.log("Sample decode time =" + sampleDecodeTimes[currentSample]);
  if ((video_previous_playback_time != currentPlaybackTime) && (currentSample < 7)){
    if (currentPlaybackTime == sampleDecodeTimes[currentSample])  //Assuming timer is accurate (defined by ticksPerSecond)
      {
	  console.log("*********Playbacktime: " + currentPlaybackTime + ", loading: " + "InteractiveTrack/sample" + (currentSample) + ".tr");
	  setTimeout(function(){loadScript("InteractiveTrack/sample" + (currentSample) + ".tr", 0);}, 0);    
	  //Load a sample	  
	  currentSample = currentSample + 1;  //Iterate over samples
      }
    video_previous_playback_time = currentPlaybackTime;
  }    
}

function loadMainBody()
{
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {      
        var nodeContents = this.responseText;
        document.getElementsByTagName('body')[0].innerHTML = nodeContents;
        loadScript("InteractiveTrack/main.tr", 1);
    }
  };
  xhttp.open("GET", "InteractiveTrack/body.xml", true);
  xhttp.send();
}

function loadScript(scriptName, isSampleZero)
{
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      
	if(isSampleZero){
	  var scriptContents = this.responseText;
	  var theScript = document.createElement('script');
	  theScript.appendChild(document.createTextNode(scriptContents));
	  document.getElementsByTagName('head')[0].appendChild(theScript);
	  scriptAdded = true;
	}
	else{
	  var scriptContentsWithTime = this.responseText;
	  var scriptContents;
	  var components = scriptContentsWithTime.split('\n');
	  time = components.shift();
	  console.log(time);
	  accumulatedTime = accumulatedTime + Number(time);
	  sampleDecodeTimes.push(accumulatedTime);
	  console.log(sampleDecodeTimes);
	  
	  scriptContents = components.join('\n');      
	  var theScript = document.createElement('script');	  
	  theScript.appendChild(document.createTextNode(scriptContents));
	  document.getElementsByTagName('head')[0].appendChild(theScript);
	  scriptAdded = true;
	}        
    }
  };
  xhttp.open("GET", scriptName, true);
  xhttp.send();
}

function loadXMLDoc() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("demo").innerHTML =
      this.responseText;
    }
  };
  xhttp.open("GET", "xmlhttp_info.txt", true);
  xhttp.send();
}
</script>


</html>
